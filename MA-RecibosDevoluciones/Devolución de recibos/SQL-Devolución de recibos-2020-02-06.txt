SELECT 	D.COD_LQ,
		D.DESC_LQ,
		D.COD_MF, 
		D.PRI_APE_MF, 
		D.PRI_NOM_MF,
		D.RESPONSABLE,
    (SELECT MAX(TO_DATE(CDATE,'DD-MM-YYYY')) FROM CB_RECIBOS_LOG LOG WHERE LOG.COD_LQ = D.COD_LQ AND LOG.COD_MF = D.COD_MF) AS FECHA_DESCARGA,
    QS_A_FECHA ||' ' ||HORA AS FECHA_DEVOLUCION,
		FIRMA,
		INGRESO AS TIPO_INGRESO,
		USUARIO
FROM (
SELECT 	L.COD_LQ,
		L.DESC_LQ,
		M.COD_MF, 
		M.PRI_APE_MF, 
		M.PRI_NOM_MF,
		M.RESPONS || ' ' ||(SELECT  R.DESCRIP FROM  cb_respon R WHERE R.RESPONS = M.RESPONS) AS RESPONSABLE
FROM MAEFUNC2 M, LIQUIDAC L 
WHERE L.COD_LQ IN ( @CODLQ )
AND M.COD_MF IN (SELECT L2.COD_MF FROM MOVLIQ L2 WHERE L2.COD_LQ IN ( @CODLQ ))
) D LEFT JOIN CB_DEVOLUCION_RECIBOS R  ON R.COD_LQ = D.COD_LQ AND D.COD_MF = R.COD_MF
ORDER BY 1,2,3








SELECT 	D.RESPONSABLE,
        R.DESCRIP,
        COUNT(DISTINCT D.COD_LQ) AS LIQUIDACIONES,
		COUNT(D.COD_MF) AS TOTAL,
        SUM(CASE WHEN RTRIM(QS_A_FECHA) = '' OR QS_A_FECHA IS NULL THEN 0 ELSE 1 END) AS  CON_DEVOLUCION,
        SUM(CASE WHEN RTRIM(QS_A_FECHA) = '' OR QS_A_FECHA IS NULL THEN 1 ELSE 0 END) AS  SIN_DEVOLUCION,
        SUM(CASE WHEN RTRIM(QS_A_FECHA) = '' OR QS_A_FECHA IS NULL THEN 1 ELSE 0 END) * 100 /  COUNT(D.COD_MF) || '%' AS FALTANTES
FROM (
SELECT 	DISTINCT L.COD_LQ,
		M.COD_MF, 
		M.RESPONS AS RESPONSABLE
FROM MAEFUNC2 M, MOVLIQ L 
WHERE L.COD_LQ IN ( @CODLQ )
AND L.COD_MF  = M.COD_MF
) D LEFT JOIN CB_DEVOLUCION_RECIBOS R  ON R.COD_LQ = D.COD_LQ AND D.COD_MF = R.COD_MF LEFT JOIN CB_RESPON R ON R.RESPONS = D.RESPONSABLE,
LIQUIDAC L 
WHERE L.COD_LQ = D.COD_LQ 
GROUP BY D.RESPONSABLE, R.DESCRIP
ORDER BY 2